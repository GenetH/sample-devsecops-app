name: DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  
jobs:

  # -------------------------------------------------------------------
  # Stage 1 — BUILD IMAGE
  # -------------------------------------------------------------------
  build:
    name: Stage 1 — Build Image
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image
        id: build-image
        run: |
          IMAGE_NAME=sample-image:${{ github.sha }}
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
          docker build -t $IMAGE_NAME .


  # -------------------------------------------------------------------
  # Stage 2 — TRIVY VULNERABILITY SCAN
  # -------------------------------------------------------------------
  trivy_scan:
    name: Stage 2 — Trivy Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull built image from previous stage
        run: docker build -t ${{ needs.build.outputs.image }} .

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build.outputs.image }}
          format: json
          output: trivy-report.json
          exit-code: "0"
          severity: "HIGH,CRITICAL"

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json


  # -------------------------------------------------------------------
  # Stage 3 — OPA POLICY ENFORCEMENT
  # -------------------------------------------------------------------
  opa_policy:
    name: Stage 3 — OPA Policy Check
    runs-on: ubuntu-latest
    needs: trivy_scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Conftest
        run: |
         wget -q https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz -O conftest.tar.gz || true
          if [ ! -s conftest.tar.gz ]; then
         VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r '.tag_name')
          wget https://github.com/open-policy-agent/conftest/releases/download/$VERSION/conftest_${VERSION#v}_Linux_x86_64.tar.gz -O conftest.tar.gz
          fi
          tar -xzf conftest.tar.gz
          sudo mv conftest /usr/local/bin/


      - name: Run OPA policy check
        run: conftest test Dockerfile --policy policies/


  # -------------------------------------------------------------------
  # Stage 4 — PUSH SECURE IMAGE
  # -------------------------------------------------------------------
  push_image:
    name: Stage 4 — Push Secure Image
    runs-on: ubuntu-latest
    needs: opa_policy
    if: success()
    steps:
      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Image Again for Push
        run: docker build -t sample-image:${{ github.sha }} .

      - name: Tag Image
        run: docker tag sample-image:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/sample-image:${{ github.sha }}

      - name: Push Image
        run: docker push ghcr.io/${{ github.repository_owner }}/sample-image:${{ github.sha }}
