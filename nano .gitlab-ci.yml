stages:
  - build
  - scan
  - enforce
  - push

variables:
  IMAGE_NAME: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"

# 1) Build Docker Image
build-image:
  stage: build
  tags: [docker]
  script:
    - docker build -t $IMAGE_NAME .
  artifacts:
    paths:
      - trivy-report.json

# 2) Vulnerability Scan (Trivy)
trivy-scan:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL --format json -o trivy-report.json $IMAGE_NAME
    - trivy image --severity HIGH,CRITICAL $IMAGE_NAME
  artifacts:
    when: always
    paths:
      - trivy-report.json
  allow_failure: false

# 3) Policy Enforcement (OPA Conftest)
opa-policy-check:
  stage: enforce
  image: openpolicyagent/conftest:latest
  script:
    - conftest test Dockerfile --policy policies/
  allow_failure: false

# 4) Push Image (only if secure & compliant)
push-image:
  stage: push
  script:
    - echo "Logging in to GitLab registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - echo "Pushing secure & compliant image..."
    - docker push $IMAGE_NAME
  only:
    - main
  needs:
    - trivy-scan
    - opa-policy-check
